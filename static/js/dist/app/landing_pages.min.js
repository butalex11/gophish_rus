var pages = [];
function save(e) {
    var a = {};
    a.name = $("#name").val(),
    editor = CKEDITOR.instances.html_editor,
    a.html = editor.getData(),
    a.capture_credentials = $("#capture_credentials_checkbox").prop("checked"),
    a.capture_passwords = $("#capture_passwords_checkbox").prop("checked"),
    a.redirect_url = $("#redirect_url_input").val(),
    -1 != e ? (a.id = pages[e].id,
    api.pageId.put(a).success((function(e) {
        successFlash("Лендинг страница успешно изменена!"),
        load(),
        dismiss()
    }
    ))) : api.pages.post(a).success((function(e) {
        successFlash("Лендинг страница успешно добавлена!"),
        load(),
        dismiss()
    }
    )).error((function(e) {
        modalError(e.responseJSON.message)
    }
    ))
}
function dismiss() {
    $("#modal\\.flashes").empty(),
    $("#name").val(""),
    $("#html_editor").val(""),
    $("#url").val(""),
    $("#redirect_url_input").val(""),
    $("#modal").find("input[type='checkbox']").prop("checked", !1),
    $("#capture_passwords").hide(),
    $("#redirect_url").hide(),
    $("#modal").modal("hide")
}
var deletePage = function(e) {
    Swal.fire({
        title: "Вы уверены?",
        text: "Лендинг страница будет удалена без возможности восстановления!",
        type: "warning",
        animation: !1,
        showCancelButton: !0,
        cancelButtonText: "Отмена",
        confirmButtonText: "Удалить " + escapeHtml(pages[e].name),
        confirmButtonColor: "#428bca",
        reverseButtons: !0,
        allowOutsideClick: !1,
        preConfirm: function() {
            return new Promise((function(a, t) {
                api.pageId.delete(pages[e].id).success((function(e) {
                    a()
                }
                )).error((function(e) {
                    t(e.responseJSON.message)
                }
                ))
            }
            ))
        }
    }).then((function(e) {
        e.value && Swal.fire("Лендинг страница удалена!", "Лендинг страница успешно удалена!", "success"),
        $('button:contains("OK")').on("click", (function() {
            location.reload()
        }
        ))
    }
    ))
};
function importSite() {
    url = $("#url").val(),
    url ? api.clone_site({
        url: url,
        include_resources: !1
    }).success((function(e) {
        $("#html_editor").val(e.html),
        CKEDITOR.instances.html_editor.setMode("wysiwyg"),
        $("#importSiteModal").modal("hide")
    }
    )).error((function(e) {
        modalError(e.responseJSON.message)
    }
    )) : modalError("Вы не ввели URL!")
}
function edit(e) {
    $("#modalSubmit").unbind("click").click((function() {
        save(e)
    }
    )),
    $("#html_editor").ckeditor(),
    setupAutocomplete(CKEDITOR.instances.html_editor);
    var a = {};
    -1 != e ? ($("#modalLabel").text("Редактирование"),
    a = pages[e],
    $("#name").val(a.name),
    $("#html_editor").val(a.html),
    $("#capture_credentials_checkbox").prop("checked", a.capture_credentials),
    $("#capture_passwords_checkbox").prop("checked", a.capture_passwords),
    $("#redirect_url_input").val(a.redirect_url),
    a.capture_credentials && ($("#capture_passwords").show(),
    $("#redirect_url").show())) : $("#modalLabel").text("Новая лендинг страница")
}
function copy(e) {
    $("#modalSubmit").unbind("click").click((function() {
        save(-1)
    }
    )),
    $("#html_editor").ckeditor();
    var a = pages[e];
    $("#name").val("Copy of " + a.name),
    $("#html_editor").val(a.html)
}
function load() {
    $("#pagesTable").hide(),
    $("#emptyMessage").hide(),
    $("#loading").show(),
    api.pages.get().success((function(e) {
        pages = e,
        $("#loading").hide(),
        pages.length > 0 ? ($("#pagesTable").show(),
        pagesTable = $("#pagesTable").DataTable({
            destroy: !0,
            columnDefs: [{
                orderable: !1,
                targets: "no-sort"
            }]
        }),
        pagesTable.clear(),
        pageRows = [],
        $.each(pages, (function(e, a) {
            pageRows.push([escapeHtml(a.name), moment(a.modified_date).format("DD.MM.YYYY, HH:mm:ss"), "<div class='pull-right'><span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Редактировать' onclick='edit(" + e + ")'>                    <i class='fa fa-pencil'></i>                    </button></span>\t\t    <span data-toggle='modal' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Копировать' onclick='copy(" + e + ")'>                    <i class='fa fa-copy'></i>                    </button></span>                    <button class='btn btn-danger' data-toggle='tooltip' data-placement='left' title='Удалить' onclick='deletePage(" + e + ")'>                    <i class='fa fa-trash-o'></i>                    </button></div>"])
        }
        )),
        pagesTable.rows.add(pageRows).draw(),
        $('[data-toggle="tooltip"]').tooltip()) : $("#emptyMessage").show()
    }
    )).error((function() {
        $("#loading").hide(),
        errorFlash("Error fetching pages")
    }
    ))
}
$(document).ready((function() {
    $(".modal").on("hidden.bs.modal", (function(e) {
        $(this).removeClass("fv-modal-stack"),
        $("body").data("fv_open_modals", $("body").data("fv_open_modals") - 1)
    }
    )),
    $(".modal").on("shown.bs.modal", (function(e) {
        void 0 === $("body").data("fv_open_modals") && $("body").data("fv_open_modals", 0),
        $(this).hasClass("fv-modal-stack") || ($(this).addClass("fv-modal-stack"),
        $("body").data("fv_open_modals", $("body").data("fv_open_modals") + 1),
        $(this).css("z-index", 1040 + 10 * $("body").data("fv_open_modals")),
        $(".modal-backdrop").not(".fv-modal-stack").css("z-index", 1039 + 10 * $("body").data("fv_open_modals")),
        $(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))
    }
    )),
    $.fn.modal.Constructor.prototype.enforceFocus = function() {
        $(document).off("focusin.bs.modal").on("focusin.bs.modal", $.proxy((function(e) {
            this.$element[0] === e.target || this.$element.has(e.target).length || $(e.target).closest(".cke_dialog, .cke").length || this.$element.trigger("focus")
        }
        ), this))
    }
    ,
    $(document).on("hidden.bs.modal", ".modal", (function() {
        $(".modal:visible").length && $(document.body).addClass("modal-open")
    }
    )),
    $("#modal").on("hidden.bs.modal", (function(e) {
        dismiss()
    }
    )),
    $("#capture_credentials_checkbox").change((function() {
        $("#capture_passwords").toggle(),
        $("#redirect_url").toggle()
    }
    )),
    CKEDITOR.on("dialogDefinition", (function(e) {
        var a = e.data.name
          , t = e.data.definition;
        "link" == a && (t.minWidth = 500,
        t.minHeight = 100,
        t.getContents("info").get("linkType").hidden = !0)
    }
    )),
    load()
}
));
